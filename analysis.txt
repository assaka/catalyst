# Magic Translation Wand Feature - Complete Analysis

## 1. FRONTEND COMPONENT
File: src/components/admin/translations/ProductTranslationRow.jsx

Import (line 2):
  import { ChevronDown, ChevronRight, Globe, Wand2 } from 'lucide-react';

Fields translated (lines 57-61):
  1. Name (single-line)
  2. Short Description (multiline)
  3. Description (multiline)

Magic Wand Button (lines 205-225):
  - Only for non-English languages
  - Disabled if source English text is empty
  - Shows spinning icon during translation
  - Tooltip: "Cost: 0.1 credits per translation"

Handler Function (lines 95-125):
  handleAITranslate(field, fromLang, toLang)
  - Validates source text
  - Calls POST /translations/ai-translate
  - Updates form on success
  - Shows toast notifications
  - Handles loading state with spinner

## 2. API ENDPOINT
File: backend/src/routes/translations.js (lines 188-257)
Route: POST /api/translations/ai-translate

Request Body:
  {
    text: string (required)
    toLang: string (required)
    fromLang: string (default: 'en')
    storeId: string
    entityType: string (e.g., 'product')
  }

Flow:
  1. translationService.getTranslationCost('product') → 0.1
  2. creditService.hasEnoughCredits(userId, storeId, 0.1)
  3. Check HTTP 402 if insufficient
  4. translationService.aiTranslate(text, 'en', toLang)
  5. creditService.deduct(userId, storeId, 0.1, description, metadata, null, 'ai_translation')
  6. Return translated text + creditsDeducted: 0.1

## 3. TRANSLATION SERVICE
File: backend/src/services/translation-service.js (lines 510-562)

getTranslationCost(entityType):
  - Maps 'product' to 'ai_translation_product'
  - Queries service_credit_costs table
  - Fallback: 0.1 credits for products

Cost Mapping:
  'product' → 0.1 credits
  'category' → 0.1 credits
  'cms_page' → 0.5 credits
  'cms_block' → 0.2 credits
  'standard' → 0.1 credits

## 4. CREDIT DEDUCTION SERVICE
File: backend/src/services/credit-service.js (lines 48-121)

deduct(userId, storeId, amount, description, metadata, referenceId, referenceType):
  
  1. Parse amount (0.1)
  2. Get current balance: SELECT credits FROM users WHERE id = userId
  3. Check: balance >= 0.1
  4. If insufficient: throw error (no deduction)
  5. Atomic SQL update:
     UPDATE users SET credits = credits - 0.1 WHERE id = userId
  6. Create audit record:
     INSERT INTO credit_usage (user_id, store_id, credits_used, description, metadata, ...)
  7. Return: { credits_deducted: 0.1, remaining_balance: X }

## 5. COMPLETE TRANSACTION FLOW

User clicks Wand Icon
  ↓
Client: POST /api/translations/ai-translate
  {text: "English text", fromLang: "en", toLang: "nl", entityType: "product"}
  ↓
Server: Check cost
  translationService.getTranslationCost('product') = 0.1
  ↓
Server: Check credits
  creditService.hasEnoughCredits(userId, storeId, 0.1)
  ├─ SELECT credits FROM users WHERE id = userId
  ├─ If balance < 0.1 → Return HTTP 402 error
  └─ If balance >= 0.1 → Continue
  ↓
Server: Translate
  translationService.aiTranslate(text, fromLang, toLang)
  ├─ Call Claude AI
  └─ Return translated text
  ↓
Server: Deduct credits
  creditService.deduct(userId, storeId, 0.1, ...)
  ├─ UPDATE users SET credits = credits - 0.1 WHERE id = userId
  ├─ INSERT INTO credit_usage (...)
  └─ Return success
  ↓
Client: Receive response
  ├─ Update form field with translated text
  ├─ Show success toast
  └─ Clear loading spinner

## 6. ERROR CASES

Insufficient Credits (HTTP 402):
  {
    "success": false,
    "code": "INSUFFICIENT_CREDITS",
    "required": 0.1,
    "available": 0.05
  }
  → No credits deducted
  → User sees error toast

Translation Failure:
  {
    "success": false,
    "message": "AI translation failed"
  }
  → No credits deducted (deduction happens after translation succeeds)

## 7. DATABASE TABLES

users:
  - Column: credits (NUMERIC type)
  - Single source of truth for balance

credit_usage (Audit Log):
  - user_id, store_id
  - credits_used: 0.1
  - usage_type: 'other'
  - reference_type: 'ai_translation'
  - description: "AI Translation (product): en → nl"
  - metadata: {entityType, fromLang, toLang, textLength, translatedLength}
  - created_at: timestamp

service_credit_costs:
  - service_key: 'ai_translation_product'
  - cost_per_unit: 0.1
  - category: 'ai_services'

## 8. COST SUMMARY

Single Field Translation: 0.1 credits
Product (3 fields) to 1 language: 0.3 credits
Product (3 fields) to 5 languages: 1.5 credits
100 products to 1 language: 30 credits
100 products to 5 languages: 150 credits

## 9. KEY FILES
- Frontend: src/components/admin/translations/ProductTranslationRow.jsx
- Endpoint: backend/src/routes/translations.js (POST /ai-translate)
- Costs: backend/src/services/translation-service.js (getTranslationCost)
- Credits: backend/src/services/credit-service.js (deduct)
