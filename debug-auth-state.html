<!DOCTYPE html>
<html>
<head>
    <title>Debug Auth State</title>
</head>
<body>
    <h1>Debug Authentication State</h1>
    <div id="output"></div>
    
    <script>
        function debugAuthState() {
            const output = document.getElementById('output');
            
            const authState = {
                currentPath: window.location.pathname.toLowerCase(),
                storeOwnerToken: localStorage.getItem('store_owner_auth_token'),
                customerToken: localStorage.getItem('customer_auth_token'),
                storeOwnerData: localStorage.getItem('store_owner_user_data'),
                selectedStoreId: localStorage.getItem('selectedStoreId'),
                userLoggedOut: localStorage.getItem('user_logged_out')
            };
            
            // Determine admin context
            const currentPath = authState.currentPath;
            const isAdminContext = currentPath.startsWith('/admin/') ||
                                  currentPath === '/dashboard' || 
                                  currentPath === '/auth' ||
                                  currentPath.includes('/dashboard') || 
                                  currentPath.includes('/products') || 
                                  currentPath.includes('/categories') || 
                                  currentPath.includes('/settings');
            
            // Parse JWT token if it exists
            let tokenInfo = null;
            if (authState.storeOwnerToken) {
                try {
                    const tokenParts = authState.storeOwnerToken.split('.');
                    if (tokenParts.length === 3) {
                        const payload = JSON.parse(atob(tokenParts[1]));
                        const currentTime = Math.floor(Date.now() / 1000);
                        tokenInfo = {
                            userId: payload.id,
                            role: payload.role,
                            exp: payload.exp,
                            isExpired: payload.exp < currentTime,
                            timeUntilExpiry: payload.exp - currentTime + ' seconds'
                        };
                    }
                } catch (e) {
                    tokenInfo = { error: 'Failed to parse JWT: ' + e.message };
                }
            }
            
            output.innerHTML = '<pre>' + JSON.stringify({
                ...authState,
                isAdminContext: isAdminContext,
                tokenInfo: tokenInfo,
                storeOwnerTokenLength: authState.storeOwnerToken ? authState.storeOwnerToken.length : 0,
                storeOwnerTokenPreview: authState.storeOwnerToken ? authState.storeOwnerToken.substring(0, 50) + '...' : null
            }, null, 2) + '</pre>';
            
            // Test if we can make an authenticated request
            if (authState.storeOwnerToken && authState.selectedStoreId) {
                console.log('üß™ Testing authenticated API call...');
                
                fetch('https://catalyst-backend-fzhu.onrender.com/api/integrations/test', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + authState.storeOwnerToken,
                        'x-store-id': authState.selectedStoreId,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ API test successful:', data);
                    const testDiv = document.createElement('div');
                    testDiv.innerHTML = '<h2>API Test Result:</h2><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    output.appendChild(testDiv);
                })
                .catch(error => {
                    console.error('‚ùå API test failed:', error);
                    const testDiv = document.createElement('div');
                    testDiv.innerHTML = '<h2>API Test Failed:</h2><pre>' + error.message + '</pre>';
                    output.appendChild(testDiv);
                });
            }
        }
        
        // Run debug on page load
        debugAuthState();
    </script>
</body>
</html>