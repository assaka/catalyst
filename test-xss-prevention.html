<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Prevention Test</title>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
</head>
<body>
    <h1>XSS Prevention Test</h1>
    <div id="output"></div>

    <script>
        // Replicate our secure HTML parser logic
        const SECURITY_CONFIGS = {
          editor: {
            ALLOWED_TAGS: [
              'b', 'i', 'u', 'strong', 'em', 'span', 'p', 'br', 'div',
              'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
              'ul', 'ol', 'li',
              'a',
              'button',
              'section', 'article'
            ],
            ALLOWED_ATTR: [
              'class', 'id', 'style', 'href', 'target', 'rel',
              'data-slot-id', 'data-editable'
            ],
            ALLOW_DATA_ATTR: true,
            FORBID_CONTENTS: ['script', 'object', 'embed', 'base', 'link'],
            FORBID_TAGS: ['script', 'object', 'embed', 'base', 'link', 'meta'],
            KEEP_CONTENT: true,
            ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\\-]+(?:[^a-z+.\\-:]|$))/i,
          }
        };

        function sanitizeHtml(html, level = 'editor') {
          if (!html || typeof html !== 'string') {
            return '';
          }

          const config = SECURITY_CONFIGS[level] || SECURITY_CONFIGS.editor;
          
          try {
            const cleanHtml = DOMPurify.sanitize(html, {
              ...config,
              RETURN_DOM: false,
              RETURN_DOM_FRAGMENT: false,
              WHOLE_DOCUMENT: false,
              SANITIZE_DOM: true,
              SANITIZE_NAMED_PROPS: true,
            });

            return cleanHtml;
          } catch (error) {
            console.error('HTML sanitization failed:', error);
            return '';
          }
        }

        function parseEditorHtml(html) {
          if (!html || typeof html !== 'string') {
            return {
              isValid: false,
              sanitizedHtml: '',
              textContent: '',
              error: 'Invalid HTML input'
            };
          }

          try {
            const sanitizedHtml = sanitizeHtml(html, 'editor');
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sanitizedHtml;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            const isValid = sanitizedHtml.trim().length > 0;
            
            return {
              isValid,
              sanitizedHtml,
              textContent: textContent.trim(),
              error: null,
              originalLength: html.length,
              sanitizedLength: sanitizedHtml.length,
              wasModified: html !== sanitizedHtml
            };
          } catch (error) {
            return {
              isValid: false,
              sanitizedHtml: '',
              textContent: '',
              error: `HTML parsing failed: ${error.message}`
            };
          }
        }

        // Run tests
        const output = document.getElementById('output');
        
        function runTest(name, html) {
          const result = parseEditorHtml(html);
          output.innerHTML += `
            <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px;">
              <h3>${name}</h3>
              <p><strong>Input:</strong> <code>${html}</code></p>
              <p><strong>Output:</strong> <code>${result.sanitizedHtml}</code></p>
              <p><strong>Valid:</strong> ${result.isValid}</p>
              <p><strong>Modified:</strong> ${result.wasModified}</p>
              <p><strong>Error:</strong> ${result.error || 'None'}</p>
            </div>
          `;
        }

        // Test cases
        runTest('Safe HTML', '<p>Hello <strong>world</strong>!</p>');
        runTest('XSS Script Attack', '<p>Hello <script>alert("XSS")</script>world</p>');
        runTest('XSS Event Handler', '<div onclick="alert(\'XSS\')">Click me</div>');
        runTest('HTML with Links', '<p>Visit <a href="https://example.com">our site</a></p>');
        runTest('Invalid HTML', '<p>Unclosed paragraph');
        runTest('Mixed Content', '<div><h2>Title</h2><p>Paragraph with <em>emphasis</em></p></div>');
    </script>
</body>
</html>